<!doctype html><html lang=en><head><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],["\\[","\\]"]],processEscapes:true,processEnvironments:true}}</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>POSTVIEWER</title><meta content=POSTVIEWER name=title><meta content=exploiitm name=author><meta content="Official blog of Cybersecurity Club, IIT Madras" name=description><meta content=website property=og:type><meta content=https://exploiitm.github.io/blog/writeups/GoogleCTF2025/postviewer/ property=og:url><meta content="exploiitm blog" property=og:site_name><meta content=POSTVIEWER property=og:title><meta content="Official blog of Cybersecurity Club, IIT Madras" property=og:description><meta content=https://exploiitm.github.io/blog/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://exploiitm.github.io/blog/writeups/GoogleCTF2025/postviewer/ property=twitter:url><meta content=POSTVIEWER property=twitter:title><meta content="Official blog of Cybersecurity Club, IIT Madras" property=twitter:description><meta content=https://exploiitm.github.io/blog/favicon.ico property=twitter:image><link href=https://exploiitm.github.io/blog/writeups/GoogleCTF2025/postviewer/ rel=canonical><link rel="shortcut icon" href=https://exploiitm.github.io/blog/favicon.ico type=image/x-icon><link href=https://speyll.github.io/suCSS/reset-min.css rel=stylesheet><link href=https://speyll.github.io/suCSS/suCSS-min.css rel=stylesheet><link href=https://exploiitm.github.io/blog/css/style.css rel=stylesheet><script defer src=https://exploiitm.github.io/blog/js/script.js></script><body><header><nav id=nav-bar><a href=https://exploiitm.github.io/> home </a><a href=/blog> blog </a><a href=/blog/writeups> writeups </a><a href=/blog/about> about </a><a href=/blog/contacts> contact </a><div><input id=theme-toggle style=display:none type=checkbox><label for=theme-toggle id=theme-toggle-label><svg class=icons id=theme-icon><use href=https://exploiitm.github.io/blog/icons.svg#lightMode></use></svg></label><audio id=theme-sound><source src=https://exploiitm.github.io/blog/click.ogg type=audio/ogg></audio></div></nav></header><main><div><a href=..>..</a>/<span class=accent-data>postviewer</span></div><time datetime=2025-08-11>Published on: <span class=accent-data>2025-08-11</span></time><address rel=author>By <span class=accent-data> Sanat Garyali, and exploiitm </span></address><h1>POSTVIEWER</h1><h1 id=postviewer-v52-writeup>POSTVIEWER v5² WRITEUP</h1><hr><h2 id=introduction>Introduction</h2><p>This year’s <strong>Postviewer</strong> in Google CTF was a SafeContentFrame (SCF) playground ,a client-side puzzle where files render on a sandbox origin instead of your app’s origin. Only <strong>2 solves</strong>. It’s intentionally evil: the fix is simple, the race is not.<hr><h3 id=1-upload-store-indexeddb>1) Upload & store (IndexedDB)</h3><p>Files (cached or non-cached) are stored client-side with metadata:<pre class=language-js data-lang=js style=background:#282828;color:#fdf4c1aa><code class=language-js data-lang=js><span style=color:#fdf4c1>async </span><span style=color:#8ec07c>addFile</span><span>({ </span><span style=color:#fdf4c1>id</span><span>, </span><span style=color:#fdf4c1>file</span><span>, </span><span style=color:#fdf4c1>cached</span><span>, </span><span style=color:#fdf4c1>isPublic</span><span>}) {
</span><span>  </span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>db </span><span style=color:#fe8019>= </span><span style=color:#fa5c4b>await </span><span style=color:#fdf4c1>this</span><span>.</span><span style=color:#fdf4c1>dbPromise</span><span>;
</span><span>  </span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>tx </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>db.</span><span style=color:#8ec07c>transaction</span><span>([</span><span style=color:#b8bb26>"files"</span><span>, </span><span style=color:#b8bb26>"info"</span><span>], </span><span style=color:#b8bb26>"readwrite"</span><span>);
</span><span>  </span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>filesdb </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>tx.</span><span style=color:#8ec07c>objectStore</span><span>(</span><span style=color:#b8bb26>"files"</span><span>);
</span><span>  </span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>infodb </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>tx.</span><span style=color:#8ec07c>objectStore</span><span>(</span><span style=color:#b8bb26>"info"</span><span>);
</span><span>
</span><span>  </span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>req </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>filesdb.</span><span style=color:#8ec07c>put</span><span>({ </span><span style=color:#fdf4c1>id</span><span>, </span><span style=color:#fdf4c1>file</span><span>, </span><span style=color:#fdf4c1>cached</span><span>, </span><span style=color:#fdf4c1>isPublic </span><span>});
</span><span>  </span><span style=color:#fa5c4b>return new </span><span style=color:#8ec07c>Promise</span><span>((</span><span style=color:#fdf4c1>resolve</span><span>) </span><span style=color:#fa5c4b>=> </span><span>{
</span><span>    </span><span style=color:#fdf4c1>req</span><span>.</span><span style=color:#8ec07c>onsuccess </span><span style=color:#fe8019>= </span><span>() </span><span style=color:#fa5c4b>=> </span><span>{
</span><span>      </span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>fileInfo </span><span style=color:#fe8019>= </span><span>{ </span><span style=color:#fdf4c1>id</span><span>, name: </span><span style=color:#fdf4c1>file</span><span>.</span><span style=color:#fabd2f>name</span><span>, </span><span style=color:#fdf4c1>cached</span><span>, </span><span style=color:#fdf4c1>isPublic</span><span>, date: </span><span style=color:#8ec07c>Date</span><span style=color:#fdf4c1>.</span><span style=color:#8ec07c>now</span><span>() };
</span><span>      </span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>req2 </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>infodb.</span><span style=color:#8ec07c>put</span><span>(</span><span style=color:#fdf4c1>fileInfo</span><span>);
</span><span>      </span><span style=color:#fdf4c1>req2</span><span>.</span><span style=color:#8ec07c>onsuccess </span><span style=color:#fe8019>= </span><span>() </span><span style=color:#fa5c4b>=> </span><span style=color:#8ec07c>resolve</span><span>(</span><span style=color:#fdf4c1>fileInfo</span><span>);
</span><span>    };
</span><span>  });
</span><span>}
</span></code></pre><figure style="text-align:center;margin:1.25rem 0"><img src=mainpage.png style=max-width:100%;height:auto></figure><h3 id=2-render-pipeline-scf-url-shim>2) Render pipeline (SCF URL + shim)</h3><p>Selecting a file (click or <code>#&LTN></code> deep-link) kicks off the SCF flow. The app computes a hash from product + salt + origin, base36’d and fixed-width, to build the <strong>shim URL</strong>:<pre class=language-js data-lang=js style=background:#282828;color:#fdf4c1aa><code class=language-js data-lang=js><span style=color:#fa5c4b>async function </span><span style=color:#8ec07c>calculateHash</span><span>(</span><span style=color:#fe8019>...</span><span style=color:#fdf4c1>parts</span><span>) {
</span><span>  </span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>encoder </span><span style=color:#fe8019>= </span><span style=color:#fa5c4b>new </span><span style=color:#8ec07c>TextEncoder</span><span>();
</span><span>  </span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>newParts </span><span style=color:#fe8019>= </span><span>[];
</span><span>  </span><span style=color:#fa5c4b>for </span><span>(</span><span style=color:#fa5c4b>let </span><span style=color:#fdf4c1>i </span><span style=color:#fe8019>= </span><span style=color:#d3869b>0</span><span>; </span><span style=color:#fdf4c1>i </span><span style=color:#fe8019>< </span><span style=color:#fdf4c1>parts</span><span>.</span><span style=color:#fabd2f>length</span><span>; </span><span style=color:#fdf4c1>i</span><span style=color:#fe8019>++</span><span>) {
</span><span>    </span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>part </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>parts</span><span>[</span><span style=color:#fdf4c1>i</span><span>];
</span><span>    </span><span style=color:#fdf4c1>newParts.</span><span style=color:#fabd2f>push</span><span>(</span><span style=color:#fe8019>typeof </span><span style=color:#fdf4c1>part </span><span style=color:#fe8019>=== </span><span style=color:#b8bb26>"string" </span><span style=color:#fe8019>? </span><span style=color:#fdf4c1>encoder.</span><span style=color:#8ec07c>encode</span><span>(</span><span style=color:#fdf4c1>part</span><span>).</span><span style=color:#fdf4c1>buffer </span><span style=color:#fe8019>: </span><span style=color:#fdf4c1>part</span><span>);
</span><span>    </span><span style=color:#fa5c4b>if </span><span>(</span><span style=color:#fdf4c1>i </span><span style=color:#fe8019>< </span><span style=color:#fdf4c1>parts</span><span>.</span><span style=color:#fabd2f>length </span><span style=color:#fe8019>- </span><span style=color:#d3869b>1</span><span>) </span><span style=color:#fdf4c1>newParts.</span><span style=color:#fabd2f>push</span><span>(</span><span style=color:#fdf4c1>encoder.</span><span style=color:#8ec07c>encode</span><span>(</span><span style=color:#b8bb26>"$@#|"</span><span>).</span><span style=color:#fdf4c1>buffer</span><span>);
</span><span>  }
</span><span>  </span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>buffer </span><span style=color:#fe8019>= </span><span style=color:#8ec07c>concatBuffers</span><span>(</span><span style=color:#fe8019>...</span><span style=color:#fdf4c1>newParts</span><span>);
</span><span>  </span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>hash </span><span style=color:#fe8019>= </span><span style=color:#fa5c4b>await </span><span style=color:#fdf4c1>crypto.subtle.</span><span style=color:#8ec07c>digest</span><span>(</span><span style=color:#b8bb26>"SHA-256"</span><span>, </span><span style=color:#fdf4c1>buffer</span><span>);
</span><span>  </span><span style=color:#fa5c4b>return </span><span style=color:#8ec07c>arrayToBase36</span><span>(</span><span style=color:#fa5c4b>new </span><span style=color:#8ec07c>Uint8Array</span><span>(</span><span style=color:#fdf4c1>hash</span><span>))</span><span style=color:#fdf4c1>.</span><span style=color:#8ec07c>padStart</span><span>(</span><span style=color:#d3869b>50</span><span>, </span><span style=color:#b8bb26>"0"</span><span>)</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>slice</span><span>(</span><span style=color:#d3869b>0</span><span>, </span><span style=color:#d3869b>50</span><span>);
</span><span>}
</span><span>
</span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>product </span><span style=color:#fe8019>= </span><span style=color:#b8bb26>"google-ctf"</span><span>;
</span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>hash </span><span style=color:#fe8019>= </span><span style=color:#fa5c4b>await </span><span style=color:#8ec07c>calculateHash</span><span>(</span><span style=color:#fdf4c1>product</span><span>, </span><span style=color:#fdf4c1>salt</span><span>, </span><span style=color:#fabd2f>window</span><span>.</span><span style=color:#fdf4c1>origin</span><span>);
</span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>url </span><span style=color:#fe8019>= </span><span style=color:#b8bb26>`https://${</span><span style=color:#fdf4c1>hash</span><span style=color:#b8bb26>}-h748636364.scf.usercontent.goog/${</span><span style=color:#fdf4c1>product</span><span style=color:#b8bb26>}/shim.html`</span><span>;
</span></code></pre><p>Then the parent creates/points the iframe and <strong>attaches <code>onload</code> before the load completes</strong>:<pre class=language-js data-lang=js style=background:#282828;color:#fdf4c1aa><code class=language-js data-lang=js><span style=color:#fdf4c1>safeFrameIframe.</span><span style=color:#fabd2f>addEventListener</span><span>(</span><span style=color:#b8bb26>"load"</span><span>, </span><span style=color:#fdf4c1>safeFrameLoaded</span><span>, </span><span style=color:#d3869b>true</span><span>);
</span><span style=color:#fdf4c1>safeFrameIframe</span><span>.</span><span style=color:#fdf4c1>src </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>url</span><span>; </span><span style=font-style:italic;color:#928374>// shim.html on SCF
</span></code></pre><h3 id=3-parent-shim-handshake-normal>3) Parent ⇄ Shim handshake (normal)</h3><p>On <strong>LOAD(shim)</strong> the parent posts the file over:<pre class=language-js data-lang=js style=background:#282828;color:#fdf4c1aa><code class=language-js data-lang=js><span style=color:#fdf4c1>safeFrameIframe.contentWindow.</span><span style=color:#fabd2f>postMessage</span><span>(
</span><span>  { </span><span style=color:#fdf4c1>body</span><span>, </span><span style=color:#fdf4c1>mimeType</span><span>, </span><span style=color:#fdf4c1>salt </span><span>},
</span><span>  </span><span style=color:#fdf4c1>url</span><span>.</span><span style=color:#fdf4c1>origin</span><span>,
</span><span>  [</span><span style=color:#fdf4c1>messageChannel</span><span>.</span><span style=color:#fdf4c1>port2</span><span>]
</span><span>);
</span></code></pre><p>Shim verifies <strong>origin+salt</strong> and replies with <strong>“Reloading iframe”</strong>; parent removes the handler and shim swaps itself for the blob file:<pre class=language-js data-lang=js style=background:#282828;color:#fdf4c1aa><code class=language-js data-lang=js><span style=color:#fa5c4b>if </span><span>(</span><span style=color:#fdf4c1>e</span><span>.</span><span style=color:#fabd2f>data</span><span>.</span><span style=color:#fdf4c1>message </span><span style=color:#fe8019>== </span><span style=color:#b8bb26>"Reloading iframe"</span><span>) {
</span><span>  </span><span style=color:#fdf4c1>safeFrameIframe.</span><span style=color:#fabd2f>removeEventListener</span><span>(</span><span style=color:#b8bb26>"load"</span><span>, </span><span style=color:#fdf4c1>safeFrameLoaded</span><span>, </span><span style=color:#d3869b>true</span><span>);
</span><span>  </span><span style=color:#8ec07c>resolve</span><span>();
</span><span>}
</span></code></pre><h3 id=4-cached-vs-non-cached-salts>4) Cached vs Non-cached salts</h3><ul><li><strong>Cached</strong>: <code>salt = encode(file.name)</code> (deterministic per filename).<li><strong>Non-cached</strong>: <code>salt = getRandom(5)</code> → 5 draws of <code>Math.random()</code> → base36 chunk per draw → concatenated.</ul><pre class=language-js data-lang=js style=background:#282828;color:#fdf4c1aa><code class=language-js data-lang=js><span style=color:#fa5c4b>function </span><span style=color:#8ec07c>getRandom</span><span>(</span><span style=color:#fdf4c1>n</span><span>) {
</span><span>  </span><span style=color:#fa5c4b>return </span><span style=color:#8ec07c>Array</span><span style=color:#fdf4c1>.</span><span style=color:#8ec07c>from</span><span>(</span><span style=color:#8ec07c>Array</span><span>(</span><span style=color:#fdf4c1>n</span><span>), </span><span style=color:#fabd2f>Math</span><span>.</span><span style=color:#fabd2f>random</span><span>)
</span><span>    </span><span style=color:#fdf4c1>.</span><span style=color:#8ec07c>map</span><span>(</span><span style=color:#fdf4c1>e </span><span style=color:#fa5c4b>=> </span><span style=color:#fdf4c1>e.</span><span style=color:#fabd2f>toString</span><span>(</span><span style=color:#d3869b>36</span><span>)</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>slice</span><span>(</span><span style=color:#d3869b>2</span><span>))
</span><span>    </span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>join</span><span>(</span><span style=color:#b8bb26>''</span><span>);
</span><span>}
</span><span>
</span><span style=color:#fa5c4b>async function </span><span style=color:#8ec07c>renderFile</span><span>({ </span><span style=color:#fdf4c1>id</span><span>, </span><span style=color:#fdf4c1>cached</span><span>, </span><span style=color:#fdf4c1>file </span><span>}, </span><span style=color:#fdf4c1>safeFrameIframe</span><span>) {
</span><span>  </span><span style=color:#fa5c4b>let </span><span style=color:#fdf4c1>salt</span><span>;
</span><span>  </span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>encoder </span><span style=color:#fe8019>= </span><span style=color:#fa5c4b>new </span><span style=color:#8ec07c>TextEncoder</span><span>();
</span><span>  </span><span style=color:#fa5c4b>if </span><span>(</span><span style=color:#fdf4c1>cached</span><span>) {
</span><span>    </span><span style=color:#fdf4c1>salt </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>encoder.</span><span style=color:#8ec07c>encode</span><span>(</span><span style=color:#fdf4c1>id</span><span>).</span><span style=color:#fdf4c1>buffer</span><span>; </span><span style=font-style:italic;color:#928374>// filename-based
</span><span>  } </span><span style=color:#fa5c4b>else </span><span>{
</span><span>    </span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>rand </span><span style=color:#fe8019>= </span><span style=color:#8ec07c>getRandom</span><span>(</span><span style=color:#d3869b>5</span><span>); </span><span style=font-style:italic;color:#928374>// 5 chunks from Math.random()
</span><span>    </span><span style=color:#fdf4c1>mathRandomInvocations.</span><span style=color:#fabd2f>push</span><span>(</span><span style=color:#fdf4c1>rand</span><span>);
</span><span>    </span><span style=color:#fdf4c1>salt </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>encoder.</span><span style=color:#8ec07c>encode</span><span>(</span><span style=color:#fdf4c1>rand</span><span>).</span><span style=color:#fdf4c1>buffer</span><span>;
</span><span>  }
</span><span>  </span><span style=color:#fa5c4b>return </span><span style=color:#fabd2f>window</span><span style=color:#fdf4c1>.</span><span style=color:#8ec07c>safeFrameRender</span><span>({
</span><span>    body: </span><span style=color:#fa5c4b>await </span><span style=color:#fdf4c1>file.</span><span style=color:#8ec07c>arrayBuffer</span><span>(), mimeType: </span><span style=color:#fdf4c1>file</span><span>.</span><span style=color:#fabd2f>type</span><span>, </span><span style=color:#fdf4c1>salt</span><span>, </span><span style=color:#fdf4c1>cached
</span><span>  }, </span><span style=color:#fdf4c1>safeFrameIframe</span><span>);
</span><span>}
</span></code></pre><h3 id=5-n-deep-link>5) <code>#&LTN></code> deep-link</h3><p>The app can auto-open a file at load if the URL ends in <code>#&LTindex></code>.<hr><h2 id=bot-behavior-context>Bot behavior (context)</h2><ol><li>Bot opens the app (localhost), adds a <strong>non-cached</strong> file containing the <strong>plaintext flag</strong>.<li>Bot visits our supplied URL (our exploit page).<li>After ~5 minutes, the bot closes the browser.</ol><p>So when our exploit runs, the <strong>flag file already exists</strong> in IndexedDB, and its <strong>salt path is driven by <code>Math.random()</code></strong>.<hr><figure style="text-align:center;margin:1.25rem 0"><img src=mainbot.png style=max-width:100%;height:auto></figure><h2 id=the-race-condition>The Race Condition</h2><blockquote><p>TL;DR: We want the <strong>parent</strong> to send <code>{…, salt}</code> <strong>twice</strong>; the second send must land while <strong>our leaker</strong> is already the iframe document, and <strong>before</strong> the parent processes the shim’s ACK (which would remove the handler).</blockquote><h3 id=normal-cycle-why-leakage-doesn-t-happen-by-default>Normal cycle (why leakage <em>doesn’t</em> happen by default)</h3><pre style=background:#282828;color:#fdf4c1aa><code><span>APP: attach onload → iframe.src = SHIM
</span><span>SHIM loads → LOAD fires → APP → SHIM: {body, mimeType, salt}
</span><span>SHIM verifies → posts ACK → APP removes onload
</span><span>SHIM replaces itself with blob(file) (file now runs) → but APP won’t send again
</span></code></pre><p><strong>Why no leak:</strong> the send happens before our doc ever runs; after ACK, onload is gone.<h3 id=exploit-vision>Exploit vision</h3><p>We need <strong>one more LOAD</strong> to be <strong>handled before</strong> the ACK. That makes APP re-run the onload handler and resend the salt into <strong>whatever</strong> is currently inside the iframe → <strong>our leaker</strong>.<h3 id=two-cycle-plan-shim1-shim2>Two-cycle plan (Shim₁ + Shim₂)</h3><p><strong>Cycle A (cached, Shim₁ → Navigator)</strong><ul><li>Share <strong>cached Navigator</strong> (a file that self-navigates).<li>Shim₁ verifies → posts ACK → (parent not stalled yet) processes it immediately → removes <em>that cycle’s</em> onload.<li>Shim₁ swaps to <strong>Navigator</strong>, which starts <strong>renavigating</strong> (e.g., via <code>setTimeout(()=>location=blob(...),150)</code>). Each navigation will produce a <strong>future iframe LOAD</strong> — these are our “extra tickets.” They exist independent of the cached-cycle handler (which is already removed).</ul><p><strong>Cycle B (non-cached, Shim₂ → Leaker)</strong><ul><li><p>Start a new cycle by sharing <strong>non-cached Leaker</strong>. Fresh <strong>onload handler attached</strong> for this cycle.</p><li><p>On <strong>LOAD(Shim₂)</strong>, APP sends <code>{…, salt_real}</code> (first send; verification).</p><li><p><strong>Freeze the parent</strong> (CPU-burn gadget) so <strong>ACK from Shim₂ is queued but unprocessed</strong>. Meanwhile:</p> <ul><li>Shim₂ swaps to <strong>Leaker</strong> (our script with <code>onmessage=e=>leak(e.data.salt)</code>).<li>Separately, a <strong>Navigator-driven navigation</strong> completes, which will result in a <strong>new LOAD</strong> destined for the parent.</ul><li><p><strong>Unfreeze</strong> the parent → queued tasks drain. With tuning:</p> <ol><li><strong>LOAD</strong> (from Navigator) fires <strong>before</strong> the <strong>ACK</strong>.<li>APP’s onload handler runs <strong>again</strong> and <strong>re-sends <code>{…, salt_real}</code></strong>, now into <strong>Leaker</strong>, which grabs and exfiltrates it.<li>Only after that does the <strong>ACK</strong> run and remove the handler. Race won.</ol></ul><h3 id=why-stalling-works>Why stalling works</h3><ul><li>The iframe lives in a separate process; it can continue completing navigations while the parent is blocked.<li>We use the built-in slow gadgets:</ul><pre class=language-js data-lang=js style=background:#282828;color:#fdf4c1aa><code class=language-js data-lang=js><span style=font-style:italic;color:#928374>// provided by the challenge (intended/unintended gadgets)
</span><span style=color:#fabd2f>window</span><span>.</span><span style=color:#8ec07c>onmessage </span><span style=color:#fe8019>= </span><span style=color:#fa5c4b>async function</span><span>(</span><span style=color:#fdf4c1>e</span><span>){
</span><span>  </span><span style=color:#fa5c4b>if</span><span>(</span><span style=color:#fdf4c1>e</span><span>.</span><span style=color:#fabd2f>data</span><span>.</span><span style=color:#fabd2f>type </span><span style=color:#fe8019>== </span><span style=color:#b8bb26>'share'</span><span>){
</span><span>    </span><span style=font-style:italic;color:#928374>// can loop absurd amounts: {file:{length:1e8}}
</span><span>    </span><span style=color:#fa5c4b>for </span><span>(</span><span style=color:#fa5c4b>var </span><span style=color:#fdf4c1>i </span><span style=color:#fe8019>= </span><span style=color:#d3869b>0</span><span>; </span><span style=color:#fdf4c1>i </span><span style=color:#fe8019>< </span><span style=color:#fdf4c1>e</span><span>.</span><span style=color:#fabd2f>data</span><span>.</span><span style=color:#fdf4c1>files</span><span>.</span><span style=color:#fabd2f>length</span><span>; </span><span style=color:#fdf4c1>i</span><span style=color:#fe8019>++</span><span>) { </span><span style=font-style:italic;color:#928374>/* burn */ </span><span>}
</span><span>  }
</span><span>  </span><span style=color:#fa5c4b>if</span><span>(</span><span style=color:#fdf4c1>e</span><span>.</span><span style=color:#fabd2f>data</span><span>.</span><span style=color:#fdf4c1>slow</span><span>){
</span><span>    </span><span style=color:#fa5c4b>for </span><span>(</span><span style=color:#fdf4c1>i </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>e</span><span>.</span><span style=color:#fabd2f>data</span><span>.</span><span style=color:#fdf4c1>slow</span><span>; </span><span style=color:#fdf4c1>i</span><span style=color:#fe8019>--</span><span>; );
</span><span>  }
</span><span>}
</span></code></pre><h3 id=navigator-leaker>Navigator & Leaker</h3><pre class=language-html data-lang=html style=background:#282828;color:#fdf4c1aa><code class=language-html data-lang=html><span style=font-style:italic;color:#928374>&LT!-- Navigator (cached) → keeps re-navigating -->
</span><span style=color:#83a598><</span><span style=font-weight:700;color:#8ec07c>script</span><span style=color:#83a598>>
</span><span style=color:#fabd2f>setTimeout</span><span style=color:#fdf4c1>(() </span><span style=color:#fa5c4b>=> </span><span style=color:#fdf4c1>{
</span><span style=color:#fdf4c1>  location </span><span style=color:#fe8019>= </span><span style=color:#8ec07c>URL</span><span style=color:#fdf4c1>.createObjectURL(
</span><span style=color:#fdf4c1>    </span><span style=color:#fe8019>new </span><span style=color:#fdf4c1>Blob([</span><span style=color:#fabd2f>document</span><span style=color:#fdf4c1>.documentElement.innerHTML], {type: </span><span style=color:#b8bb26>'text/html'</span><span style=color:#fdf4c1>})
</span><span style=color:#fdf4c1>  );
</span><span style=color:#fdf4c1>}, </span><span style=color:#d3869b>150</span><span style=color:#fdf4c1>);
</span><span style=color:#83a598>&LT/</span><span style=font-weight:700;color:#8ec07c>script</span><span style=color:#83a598>>
</span></code></pre><pre class=language-html data-lang=html style=background:#282828;color:#fdf4c1aa><code class=language-html data-lang=html><span style=font-style:italic;color:#928374>&LT!-- Leaker (non-cached) → catch the resend -->
</span><span style=color:#83a598><</span><span style=font-weight:700;color:#8ec07c>script</span><span style=color:#83a598>>
</span><span style=color:#fdf4c1>onmessage </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>e </span><span style=color:#fa5c4b>=> </span><span style=color:#fdf4c1>leak(e.data.salt);
</span><span style=color:#83a598>&LT/</span><span style=font-weight:700;color:#8ec07c>script</span><span style=color:#83a598>>
</span></code></pre><h3 id=handler-timing>handler timing</h3><ul><li><strong>Loads only help if the onload handler is attached at that moment.</strong><li>Cached cycle: ACK processed immediately → handler gone → Navigator’s initial loads are ignored by the parent (but they still <em>happen</em>, which is important).<li>Non-cached cycle: fresh handler attached; we <strong>delay</strong> its ACK; now a Navigator load fires while handler is <strong>still attached</strong> → second send happens.</ul><hr><h2 id=after-the-leak-prng-xss-pivot-flag>After the leak: PRNG → XSS pivot → flag</h2><p>Once we have <strong>one</strong> non-cached salt, the rest is deterministic engineering.<h3 id=1-split-the-salt-into-5-base36-chunks>1) Split the salt into 5 base36 chunks</h3><p>The non-cached salt is the concatenation of 5 <code>Math.random()</code> outputs in base36. E.g.<pre class=language-js data-lang=js style=background:#282828;color:#fdf4c1aa><code class=language-js data-lang=js><span style=color:#fdf4c1>salt </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>r1.</span><span style=color:#fabd2f>toString</span><span>(</span><span style=color:#d3869b>36</span><span>)</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>slice</span><span>(</span><span style=color:#d3869b>2</span><span>)
</span><span>     </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>r2.</span><span style=color:#fabd2f>toString</span><span>(</span><span style=color:#d3869b>36</span><span>)</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>slice</span><span>(</span><span style=color:#d3869b>2</span><span>)
</span><span>     </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>r3.</span><span style=color:#fabd2f>toString</span><span>(</span><span style=color:#d3869b>36</span><span>)</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>slice</span><span>(</span><span style=color:#d3869b>2</span><span>)
</span><span>     </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>r4.</span><span style=color:#fabd2f>toString</span><span>(</span><span style=color:#d3869b>36</span><span>)</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>slice</span><span>(</span><span style=color:#d3869b>2</span><span>)
</span><span>     </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>r5.</span><span style=color:#fabd2f>toString</span><span>(</span><span style=color:#d3869b>36</span><span>)</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>slice</span><span>(</span><span style=color:#d3869b>2</span><span>);
</span></code></pre><p>Chunk lengths vary (~10–12 chars). Recovering them is a small search:<ul><li>Try plausible 5-way splits (start with 11/11/11/11/11, adjust ±1 where needed).<li>Convert base36 chunk → float in <code>[0,1)</code> approximation.<li>Check if a consistent JS-PRNG progression fits those 5 outputs (don’t over-explain engine specifics; we just verify consistency and move forward).</ul><p>Outcome: <strong>five consecutive PRNG outputs</strong> recovered.<h3 id=2-recover-prng-state-predict-forward>2) Recover PRNG state & predict forward</h3><p>With several consecutive outputs, you can reconstruct the PRNG’s state and produce <strong>future</strong> <code>Math.random()</code> values on demand. End product: a <code>nextRandom()</code> you control.<h3 id=3-hunt-a-short-predicted-salt-51-chars-total>3) Hunt a <strong>short</strong> predicted salt (< 51 chars total)</h3><p>We need a predicted concatenation <code>S* = s1+s2+s3+s4+s5</code> whose <strong>total length < 51</strong>. Iterate <code>nextRandom()</code> 5-at-a-time until such a concatenation appears.<h3 id=4-craft-a-cached-xss-pinned-to-that-salt>4) Craft a <strong>cached XSS</strong> pinned to that salt</h3><ul><li>Create a <strong>cached</strong> file whose <strong>filename = <code>S*</code></strong> and whose <strong>content hash is shorter than the filename length</strong> so the app uses <strong>filename-as-salt</strong> (not the hash).<li>Rendering this cached file now fixes the SCF origin to the one derived from <code>S*</code> - same origin your future non-cached flag render will use when the PRNG lands on <code>S*</code>.</ul><h3 id=5-keep-a-handle-to-the-scf-doc>5) Keep a handle to the SCF doc</h3><p>The app hides the SCF iframe behind a <code>shadowRoot</code>. From your XSS, <strong>open</strong> or <strong>navigate</strong> to that exact SCF URL and <strong>store a reference</strong> so you can still talk to it later:<pre class=language-js data-lang=js style=background:#282828;color:#fdf4c1aa><code class=language-js data-lang=js><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>scfUrl </span><span style=color:#fe8019>= </span><span style=color:#8ec07c>makeScfUrlFromSalt</span><span>(</span><span style=color:#fdf4c1>Sstar</span><span>);
</span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>w </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>window</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>open</span><span>(</span><span style=color:#fdf4c1>scfUrl</span><span>, </span><span style=color:#b8bb26>"scfS"</span><span>); </span><span style=font-style:italic;color:#928374>// or keep a ref after location.replace
</span><span style=font-style:italic;color:#928374>// later: w.document.body.textContent → same-origin DOM read
</span></code></pre><h3 id=6-burn-salts-until-the-next-non-cached-s>6) Burn salts until the next non-cached = <code>S*</code></h3><p>Each non-cached render consumes <strong>5</strong> PRNG draws. Force the app to render dummy non-cached files to advance in steps of 5 until the predictor says the <strong>next</strong> salt will be <code>S*</code>.<h3 id=7-render-the-flag-file>7) Render the <strong>flag</strong> file</h3><p>Trigger the app to render the real flag file. Its non-cached salt equals <code>S*</code> now → it loads on <strong>the same SCF origin</strong> as your cached XSS payload.<h3 id=8-same-origin-victory>8) Same-origin = victory</h3><h2 id=end-to-end-playbook-recapped>End-to-end playbook-recapped</h2><ol><li>Share cached <strong>Navigator</strong>; let it start looping navigations (extra LOADs exist now).<li>Start non-cached <strong>Leaker</strong>; fresh onload attached; first send verifies.<li><strong>Stall</strong> parent; ACK delayed; iframe swaps to <strong>Leaker</strong>.<li><strong>Unstall</strong>; a queued <strong>LOAD</strong> fires <strong>before</strong> ACK → parent re-sends salt → <strong>Leaker</strong> leaks.<li><strong>Split</strong> leaked salt → recover PRNG → <strong>predict</strong> forward.<li>Find <strong>short</strong> predicted salt <code>&LT51</code> → craft <strong>cached XSS</strong> with <code>filename=S*</code> and body-hash shorter than filename.<li><strong>Store handle</strong> to <code>SCF(S*)</code> document.<li><strong>Burn</strong> PRNG outputs (dummy non-cached renders) until next non-cached salt = <code>S*</code>.<li>Render <strong>flag</strong> → now on same SCF origin as our XSS → <strong>read & exfil</strong>.</ol><h2 id=environment>Environment</h2><p>I was using Arch which gave me 2 separate headaches:<ul><li><strong>Networking:</strong> bot can’t hit private LAN IPs<li><strong>Dependencies:</strong> Arch + pip + sagemath created conflict hell.</ul><p>Fix: spin a tiny <strong>Ubuntu 22.04</strong> VM on Goggle Cloud with a <strong>public IP</strong>, open HTTP.<figure style="text-align:center;margin:1.25rem 0"><img src=server.png style=max-width:100%;height:auto></figure><h3 id=flag>Flag:</h3><figure style="text-align:center;margin:1.25rem 0"><img src=mainflag.png style=max-width:100%;height:auto></figure> ``` <p class=tags-data></main><footer><hr><div class=footContainer><div class=footLeft><p>Licensed under <a rel="noopener noreferrer" href=https://fr.wikipedia.org/wiki/Licence_MIT target=_blank>MIT</a><br></div><div class=footRight><img class="footGif noStyle" alt=footGif loading=lazy src=https://i.ibb.co/XYDpfcs/foot.gif><a rel="noopener noreferrer" title="Subscribe via RSS for updates." class=metaData href=https://exploiitm.github.io/blog/atom.xml target=_blank>RSS</a></div></div></footer>